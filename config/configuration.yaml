
# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

knx: !include knx/all.yaml

logger:
  default: info
  logs:
    custom_components.shadow_control: debug

template:
  - sensor:
      - name: test_brightness
        state: "55"
      - name: test_elevation
        state: "30"
      - name: test_azimuth
        state: "180"

      # Sensor für die berechnete Zielhöhe
      - name: "Shadow Control Zielhöhe"
        unique_id: shadow_control_target_height
        state: "{{ state_attr('cover.test_shadow_control', 'calculated_target_height') }}"
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:ruler-vertical

      # Sensor für den berechneten Zielwinkel
      - name: "Shadow Control Zielwinkel"
        unique_id: shadow_control_target_angle
        state: "{{ state_attr('cover.test_shadow_control', 'calculated_target_angle') }}"
        unit_of_measurement: "°"
        state_class: measurement
        icon: mdi:rotate-3d

      # Sensor für den aktuellen Shutter Control Zustand
      - name: "Shadow Control Zustand"
        unique_id: shadow_control_current_state
        state: "{{ state_attr('cover.test_shadow_control', 'current_shutter_state') }}"
        icon: mdi:state-machine

      # Sensor für den aktuellen Lock Zustand
      - name: "Shadow Control Sperr-Zustand"
        unique_id: shadow_control_lock_state
        state: "{{ state_attr('cover.test_shadow_control', 'current_lock_state') }}"
        icon: mdi:lock-open-check

  - binary_sensor:
      - name: shadow_handling_activation
        state: "on"

input_number:
  # =========================================================================
  # Dynamic inputs
  d01_brightness:
    #[e#5 trigger    =Helligkeit (Lux)                                     ]
    name: "D01: Sun Brightness"
    min: 0
    max: 100000
    step: 100
    mode: slider
    initial: 1000
  d02_brightness_dawn:
    #[e#6 trigger    =Helligkeit Daemmerung (Lux)                          ]
    name: "D02: Sun Brightness (dawn)"
    min: 0
    max: 100000
    step: 100
    mode: slider
    initial: 1000
  d03_sun_elevation:
    #[e#7 trigger    =Elevation Sonne (°)                     #init=45     ]
    name: "D03: Sun Elevation"
    min: 0
    max: 90
    step: 1
    mode: slider
    initial: 45
  d04_sun_azimuth:
    #[e#8 trigger    =Azimut Sonne (°)                        #init=180    ]
    name: "D04: Sun Azimuth"
    min: 0
    max: 359
    step: 1
    mode: slider
    initial: 180
  d05_shutter_current_height:
    #[e#9            =Hoehe Ist-Wert (%)                                   ]
    name: "D05: Current height"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 50
  d06_shutter_current_angle:
    #[e#10           =Winkel Ist-Wert (%)                                  ]
    name: "D06: Current angle"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 50
  d09_lock_height:
    #[e#14           =Hoehe bei Sperre (%)                    #init=0      ]
    name: "D09: Lock w. constraint height"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 50
  d10_lock_angle:
    #[e#15           =Winkel bei Sperre (%)                   #init=0      ]
    name: "D10: Lock w. constraint angle"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 50
  d11_modification_tolerance_height:
    #[e#16           =Toleranz f. ext. Hoehenaenderung (%)    #init=8      ]
    name: "D11: Tolerance height"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 8
  d12_modification_tolerance_angle:
    #[e#17           =Toleranz f. ext. Winkelaenderung (%)    #init=5      ]
    name: "D12: Tolerance angle"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 5
  # Dynamic inputs end
  # =========================================================================
  # General settings:
  g01_azimuth_facade:
    #[e#20 important =Azimut Fassade (°)                      #init=180    ]
    name: "G01: Azimuth facade (°)"
    min: 0
    max: 359
    step: 1
    mode: slider
    initial: 180
  g02_offset_sun_in:
    #[e#21           =Offset Sonne Eintritt (°)               #init=-90    ]
    name: "G02: Offset Sun IN (°)"
    min: -90
    max: 0
    step: 1
    mode: slider
    initial: -90
  g03_offset_sun_out:
    #[e#22           =Offset Sonne Austritt (°)               #init=90     ]
    name: "G03: Offset Sun OUT (°)"
    min: 0
    max: 90
    step: 1
    mode: slider
    initial: 90
  g04_elevation_sun_min:
    #[e#23           =Min Elevation (°)                       #init=0      ]
    name: "G04: Elevation Sun Min (°)"
    min: 0
    max: 90
    step: 1
    mode: slider
    initial: 0
  g05_elevation_sun_max:
    #[e#24           =Max Elevation (°)                       #init=90     ]
    name: "G05: Elevation Sun Max (°)"
    min: 0
    max: 90
    step: 1
    mode: slider
    initial: 90
  g06_slat_width:
    #[e#25 important =Lamellenbreite (mm)                     #init=80     ]
    name: "G06: Shutter slat width (mm)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 80
  g07_slat_distance:
    #[e#26 important =Lamellenabstand (mm)                    #init=40     ]
    name: "G07: Shutter slat distance (mm)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 40
  g08_angle_offset:
    #[e#27           =Winkel-Offset (%)                       #init=0      ]
    name: "G08: Angle offset (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  g09_min_slat_angle:
    #[e#28           =Min. Lamellenwinkel (%)                 #init=0      ]
    name: "G09: Min slat angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  g10_stepping_height:
    #[e#35           =Hoehen-Schrittweite (%)                 #init=5      ]
    name: "G10: Height stepping (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 5
  g11_stepping_angle:
    #[e#29           =Winkel-Schrittweite (%)                 #init=5      ]
    name: "G11: Angle stepping (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 5
  g13_light_bar_width:
    #[e#31           =Lichtstreifen (mm)                      #init=0      ]
    name: "G13: Light bar width (mm)"
    min: 0
    max: 2000
    step: 10
    mode: slider
    initial: 0
  g14_shutter_height:
    #[e#32           =Gesamthoehe (mm)                        #init=2000   ]
    name: "G14: Shutter height (mm)"
    min: 0
    max: 3000
    step: 10
    mode: slider
    initial: 2000
  g15_neutral_pos_height:
    #[e#33           =Hoehe Neutralposition (%)               #init=0      ]
    name: "G15: Neutral height (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  g16_neutral_pos_angle:
    #[e#34           =Winkel Neutralposition (%)              #init=0      ]
    name: "G15: Neutral angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  # General settings end
  # =========================================================================
  # Shadow settings
  s02_shadow_brightness_level:
    #[e#41 important =Beschattungsschwelle (schliessen, Lux)  #init=50000  ]
    name: "S02: Shadow brightness level"
    min: 0
    max: 100000
    step: 100
    mode: slider
    initial: 50000
  s03_shadow_after_seconds:
    #[e#42           =Beschattung nach x Sekunden             #init=150    ]
    name: "S03: Shadow after n seconds"
    min: 0
    max: 3600
    step: 15
    mode: slider
    initial: 150
  s04_shadow_max_height:
    #[e#43           =Max. Hoehe bei Beschattung (%)          #init=100    ]
    name: "S04: Shadow max height (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  s05_shadow_max_angle:
    #[e#44           =Max. Winkel bei Beschattung (%)         #init=100    ]
    name: "S05: Shadow max angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  s06_shadow_look_through_seconds:
    #[e#45           =Durchsicht nach y Sekunden              #init=900    ]
    name: "S03: Look through after n seconds"
    min: 0
    max: 7200
    step: 15
    mode: slider
    initial: 900
  s07_shadow_open_seconds:
    #[e#46           =Oeffnen nach z Sekunden                 #init=3600   ]
    name: "S07: Open after n seconds"
    min: 0
    max: 7200
    step: 15
    mode: slider
    initial: 3600
  s08_shadow_look_through_angle:
    #[e#47           =Winkel Durchsicht (%)                   #init=0      ]
    name: "S08: Shadow look through angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  s09_after_shadow_height:
    #[e#48           =Hoehe nach Beschattung (%)              #init=0      ]
    name: "S09: Height after shadow (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  s10_after_shadow_angle:
    #[e#49           =Winkel nach Beschattung (%)             #init=0      ]
    name: "S10: Angle after shadow (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  # Shadow settings end
  # =========================================================================
  # Dawn settings
  sd02_dawn_brightness_level:
    #[e#41 important =Daemmerungsschwelle (schliessen, Lux)  #init=50000  ]
    name: "SD02: Dawn brightness level"
    min: 0
    max: 100000
    step: 100
    mode: slider
    initial: 50000
  sd03_dawn_after_seconds:
    #[e#42           =Daemmerungsposition nach x Sekunden             #init=150    ]
    name: "SD03: Dawn after n seconds"
    min: 0
    max: 3600
    step: 15
    mode: slider
    initial: 150
  sd04_dawn_max_height:
    #[e#43           =Max. Hoehe bei Daemmerung (%)          #init=100    ]
    name: "SD04: Dawn max height (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  sd05_dawn_max_angle:
    #[e#44           =Max. Winkel bei Daemmerung (%)         #init=100    ]
    name: "SD05: Dawn max angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  sd06_dawn_look_through_seconds:
    #[e#45           =Durchsicht nach y Sekunden              #init=900    ]
    name: "SD03: Look through after n seconds"
    min: 0
    max: 7200
    step: 15
    mode: slider
    initial: 900
  sd07_dawn_open_seconds:
    #[e#46           =Oeffnen nach z Sekunden                 #init=3600   ]
    name: "SD07: Open after n seconds"
    min: 0
    max: 7200
    step: 15
    mode: slider
    initial: 3600
  sd08_dawn_look_through_angle:
    #[e#47           =Winkel Durchsicht (%)                   #init=0      ]
    name: "SD08: Dawn look through angle (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  sd09_after_dawn_height:
    #[e#48           =Hoehe nach Daemmerung (%)              #init=0      ]
    name: "SD09: Height after dawn (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  sd10_after_dawn_angle:
    #[e#49           =Winkel nach Daemmerung (%)             #init=0      ]
    name: "SD10: Angle after dawn (%)"
    min: 0
    max: 100
    step: 1
    mode: slider
    initial: 0
  # Dawn settings end
  # =========================================================================

  test_cover_position:
    name: Test Cover Position
    min: 0
    max: 100
    step: 1
    initial: 0
  test_cover_tilt_position:
    name: Test Cover Tilt Position
    min: 0
    max: 100
    step: 1
    initial: 0

input_boolean:
  # =========================================================================
  # Dynamic inputs
  d07_lock_integration:
    #[e#12 trigger   =Bausteinsperre (0/1)                    #init=0      ]
    name: "D07: Locked"
  d08_lock_integration_with_position:
    #[e#13 trigger   =Sperre mit Zwangsposition (0/1)         #init=0      ]
    name: "D08: Locked with position constraint"
  # Dynamic inputs end
  # =========================================================================
  # Shadow settings
  s01_shadow_control_enabled:
    #[e#40 trigger   =Beschattungssteuerung aktiv (0/1)       #init=1      ]
    name: "S01: Shadow control"
  # Shadow settings end
  # =========================================================================
  # Dawn settings
  sd01_dawn_control_enabled:
    #[e#60 trigger   =Daemmerungssteuerung aktiv (0/1)        #init=1      ]
    name: "SD01: Dawn control"
  # Dawn settings end
  # =========================================================================

input_select:
  # =========================================================================
  # Dynamic inputs
  # ...
  # Dynamic inputs end
  # =========================================================================
  # General settings
  g12_shutter_type:
    #[e#30           =Typ, Schwenkbereich (0/1)               #init=0      ]
    name: "G12: Shutter type"
    options:
      - "0-90"
      - "0-180"
    initial: "0-90"
  g17_movement_restriction_height:
    #[e#36           =Bwg Hoehe einschraenken (0/1/2)         #init=0      ]
    name: "G17: Move restriction height"
    options:
      - "No restriction"
      - "Only close"
      - "Only open"
    initial: "No restriction"
  g18_movement_restriction_angle:
    #[e#37           =Bwg Winkel einschraenken (0/1/2)        #init=0      ]
    name: "G18: Move restriction angle"
    options:
      - "No restriction"
      - "Only close"
      - "Only open"
    initial: "No restriction"
  g19_update_lock_output:
    #[e#38           =Update Sperrausgang (0/1/2)             #init=0      ]
    name: "G19: Update lock output"
    options:
      - "0"
      - "1"
      - "2"
    initial: "0"
  # General settings end
  # =========================================================================
  # Shadow settings
  # ...
  # Shadow settings end
  # =========================================================================
  # Dawn settings
  # ...
  # Dawn settings end
  # =========================================================================

cover:
  - platform: shadow_control  # Verwenden Sie hier den Namen Ihrer Plattform
    name: "Test Shadow Control"
    cover: cover.test_cover1
    target_cover_entity_id: "cover.fenster_buro_ost"

    # === Dynamische Eingänge (Test-Helfer) ===
    brightness_entity_id: input_number.d01_brightness
    brightness_dawn_entity_id: input_number.d02_brightness_dawn
    sun_elevation_entity_id: input_number.d03_sun_elevation
    sun_azimuth_entity_id: input_number.d04_sun_azimuth
    shutter_current_height_entity_id: input_number.d05_shutter_current_height
    shutter_current_angle_entity_id: input_number.d06_shutter_current_angle
    lock_integration_entity_id: input_boolean.d07_lock_integration
    lock_integration_with_position_entity_id: input_boolean.d08_lock_integration_with_position
    lock_height_entity_id: input_number.d09_lock_height
    lock_angle_entity_id: input_number.d10_lock_angle
    modification_tolerance_height_entity_id: input_number.d11_modification_tolerance_height
    modification_tolerance_angle_entity_id: input_number.d12_modification_tolerance_angle

    # === Allgemeine Einstellungen (Test-Helfer) ===
    azimuth_facade_entity_id: input_number.g01_azimuth_facade
    offset_sun_in_entity_id: input_number.g02_offset_sun_in
    offset_sun_out_entity_id: input_number.g03_offset_sun_out
    elevation_sun_min_entity_id: input_number.g04_elevation_sun_min
    elevation_sun_max_entity_id: input_number.g05_elevation_sun_max
    slat_width_entity_id: input_number.g06_slat_width
    slat_distance_entity_id: input_number.g07_slat_distance
    angle_offset_entity_id: input_number.g08_angle_offset
    min_slat_angle_entity_id: input_number.g09_min_slat_angle
    stepping_height_entity_id: input_number.g10_stepping_height
    stepping_angle_entity_id: input_number.g11_stepping_angle
    shutter_type_entity_id: input_select.g12_shutter_type
    light_bar_width_entity_id: input_number.g13_light_bar_width
    shutter_height_entity_id: input_number.g14_shutter_height
    neutral_pos_height_entity_id: input_number.g15_neutral_pos_height
    neutral_pos_angle_entity_id: input_number.g16_neutral_pos_angle
    movement_restriction_height_entity_id: input_select.g17_movement_restriction_height
    movement_restriction_angle_entity_id: input_select.g18_movement_restriction_angle
    update_lock_output_entity_id: input_select.g19_update_lock_output

    # === Beschattungseinstellungen (Test-Helfer) ===
    shadow_control_enabled_entity_id: input_boolean.s01_shadow_control_enabled
    shadow_brightness_level_entity_id: input_number.s02_shadow_brightness_level
    shadow_after_seconds_entity_id: input_number.s03_shadow_after_seconds
    shadow_max_height_entity_id: input_number.s04_shadow_max_height
    shadow_max_angle_entity_id: input_number.s05_shadow_max_angle
    shadow_look_through_seconds_entity_id: input_number.s06_shadow_look_through_seconds
    shadow_open_seconds_entity_id: input_number.s07_shadow_open_seconds
    shadow_look_through_angle_entity_id: input_number.s08_shadow_look_through_angle
    after_shadow_height_entity_id: input_number.s09_after_shadow_height
    after_shadow_angle_entity_id: input_number.s10_after_shadow_angle

    # === Dämmerungseinstellungen (Test-Helfer) ===
    dawn_control_enabled_entity_id: input_boolean.sd01_dawn_control_enabled
    dawn_brightness_level_entity_id: input_number.sd02_dawn_brightness_level
    dawn_after_seconds_entity_id: input_number.sd03_dawn_after_seconds
    dawn_max_height_entity_id: input_number.sd04_dawn_max_height
    dawn_max_angle_entity_id: input_number.sd05_dawn_max_angle
    dawn_look_through_seconds_entity_id: input_number.sd06_dawn_look_through_seconds
    dawn_open_seconds_entity_id: input_number.sd07_dawn_open_seconds
    dawn_look_through_angle_entity_id: input_number.sd08_dawn_look_through_angle
    after_dawn_height_entity_id: input_number.sd09_after_dawn_height
    after_dawn_angle_entity_id: input_number.sd10_after_dawn_angle

  - platform: template
    covers:
      test_cover:
        unique_id: "testcover1"
        friendly_name: "Test Cover 1"
        device_class: blind
        open_cover:
          service: script.test_cover_open
        close_cover:
          service: script.test_cover_close
        stop_cover:
          service: script.test_cover_stop
        set_cover_position:
          service: script.test_cover_set_position
          data:
            position: "{{ position }}"
        position_template: >
          {% set position_value = state_attr('input_number.test_cover_position', 'value') %}
          {{ position_value | float | int if position_value is not none else 0 }}
        tilt_template: >
          {% set tilt_value = state_attr('input_number.test_cover_tilt_position', 'value') %}
          {{ tilt_value | float | int if tilt_value is not none else 0 }}
